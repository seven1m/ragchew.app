<h1>User: <%== @user_to_edit.call_sign %></h1>

<p><a href="https://www.qrz.com/db/<%= url_escape @user_to_edit.call_sign.upcase %>">QRZ</a></p>

<dl>
  <dt>First name:</dt>
  <dd><%== @user_to_edit.first_name %></dd>
  <dt>Last name:</dt>
  <dd><%== @user_to_edit.last_name %></dd>
  <dt>Image URL:</dt>
  <dd>
    <% if @user_to_edit.image.present? %>
      <a href="<%= make_url_safe_for_html_attribute @user_to_edit.image %>"><%== @user_to_edit.image %></a><br/>
      <a href="<%= make_url_safe_for_html_attribute @user_to_edit.image %>">
        <img style="height:100px" src="<%= make_url_safe_for_html_attribute @user_to_edit.image %>"/>
      </a>
    <% else %>
      <em>none</em>
    <% end %>
  </dd>
  <dt>Last signed in:</dt>
  <dd><%= format_time @user_to_edit.last_signed_in_at %></dd>
  <dt>Created at:</dt>
  <dd><%= format_time @user_to_edit.created_at %></dd>
  <dt>Updated at:</dt>
  <dd><%= format_time @user_to_edit.updated_at %></dd>
  <dt>Monitoring net:</dt>
  <dd>
    <% if @user_to_edit.monitoring_net %>
      <a href="/admin/nets/<%= url_escape @user_to_edit.monitoring_net.name %>"><%== @user_to_edit.monitoring_net.name %></a>
    <% else %>
      <em>none</em>
    <% end %>
  </dd>
  <dt>Monitoring net last refreshed at:</dt>
  <dd>
    <% if @user_to_edit.monitoring_net_last_refreshed_at %>
      <%= format_time @user_to_edit.monitoring_net_last_refreshed_at %>
    <% else %>
      <em>none</em>
    <% end %>
  </dd>
  <dt>Logging net:</dt>
  <dd>
    <% if @user_to_edit.logging_net %>
      <a href="/admin/nets/<%= url_escape @user_to_edit.logging_net.name %>"><%== @user_to_edit.logging_net.name %></a>
      (last change <%== distance_of_time_in_words Time.now, @user_to_edit.logging_net.checkins.maximum(:updated_at) %> ago)
    <% else %>
      <em>none</em>
    <% end %>
  </dd>
  <dt>Flags:</dt>
  <dd><%== @user_to_edit.flags %></dd>
</dl>

<form action="/admin/users/<%= @user_to_edit.id %>" method="POST">
  <label>
    <input type="checkbox" name="admin" value="true" <%= @user_to_edit.admin? ? 'checked' : '' %>/>
    Admin
  </label>
  <label>
    <input type="checkbox" name="net_logger" value="true" <%= @user_to_edit.net_logger? ? 'checked' : '' %>/>
    Net Logger (beta)
  </label>
  <input type="submit" value="Save"/>
</form>

<a name="clubs"></a>
<h2>Clubs</h2>

<% if @club_members.any? %>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Full Name</th>
          <th>Joined</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @club_members.each do |club_member| %>
          <tr>
            <td><a href="/admin/clubs/<%== club_member.club_id %>/edit"><%== club_member.club.name %></a></td>
            <td><%== club_member.club.full_name %></td>
            <td><%= format_time(club_member.created_at) %></td>
            <td>
              <form class="inline" action="/admin/users/<%== @user_to_edit.id %>/clubs/<%== club_member.club_id %>" method="post" onclick="if (!confirm('Are you sure?')) return false">
                <input type="hidden" name="_method" value="delete"/>
                <button>Remove</button>
              </form>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <p><em>none</em></p>
<% end %>

<div id="club-search-form" style="position: relative;">
  <label>
    Search for club to add:<br/>
    <input type="text" id="club-search" placeholder="Type club name..." autocomplete="off" style="width: 300px;"/>
  </label>
  <div id="club-search-results" style="display: none; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; background: white; position: absolute; z-index: 1000; width: 300px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>
</div>

<script>
let searchTimeout;
const searchInput = document.getElementById('club-search');
const resultsDiv = document.getElementById('club-search-results');

searchInput.addEventListener('input', function() {
  clearTimeout(searchTimeout);
  const query = this.value.trim();

  if (query.length < 2) {
    resultsDiv.style.display = 'none';
    return;
  }

  searchTimeout = setTimeout(() => {
    fetch(`/admin/clubs/search?q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(clubs => {
        if (clubs.length === 0) {
          resultsDiv.innerHTML = '<div style="padding: 10px; color: #666;">No clubs found</div>';
        } else {
          resultsDiv.innerHTML = clubs.map(club => 
            `<div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" 
                  onclick="addUserToClub(${club.id}, '${escapeHtml(club.name)}')"
                  onmouseover="this.style.backgroundColor='#f5f5f5'"
                  onmouseout="this.style.backgroundColor='white'">
               <strong>${escapeHtml(club.name)}</strong>
               ${club.full_name ? `<br/><small>${escapeHtml(club.full_name)}</small>` : ''}
             </div>`
          ).join('');
        }
        resultsDiv.style.display = 'block';
      })
      .catch(error => {
        console.error('Search error:', error);
        resultsDiv.innerHTML = '<div style="padding: 10px; color: red;">Search error</div>';
        resultsDiv.style.display = 'block';
      });
  }, 300);
});

// Hide results when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('#club-search-form')) {
    resultsDiv.style.display = 'none';
  }
});

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function addUserToClub(clubId, clubName) {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `/admin/users/<%== @user_to_edit.id %>/clubs`;

  const clubIdInput = document.createElement('input');
  clubIdInput.type = 'hidden';
  clubIdInput.name = 'club_id';
  clubIdInput.value = clubId;

  form.appendChild(clubIdInput);
  document.body.appendChild(form);
  form.submit();

  resultsDiv.style.display = 'none';
  searchInput.value = '';
}
</script>
